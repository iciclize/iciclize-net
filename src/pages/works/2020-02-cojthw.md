---
slug: "cojt-hw"
date: "2020-02"
title: "グラフィックスプロセッサ"
description: "FPGAでグラフィックスプロセッサを設計するコース、組み込み技術キャンパスOJT ハードウェアコースを1年間受講したのでその概要です。"
imagename: "work-cojt-hw.png"
---

3年次の学生実験(の代わり？)として受講できる「組み込み技術キャンパスOJT(COJT) ハードウェアコース」の成果として「透明人間回路」という作品を発表しました。

<small>動画内で言ってること意味不明すぎワロタ</small>

<iframe width="560" height="315" src="https://www.youtube.com/embed/y0vV2u8ot3w?start=427" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

作品の説明としては、「画面の右半分の、肌っぽい色以外のピクセルを左半分に転送すると、画面の左半分に映っている人間が透明人間に見える」という作品です。

作品としてはそんなに映えるものではないのですが、製作の道のりがなかなか険しかったのでその頑張りをこの作品集のページに載せたいのです。

## COJT ハードウェアコースとは

> 　春学期は「映像信号の入出力」をテーマに、基本的なハードウェア記述言語の記述方法を学んだ後、ディスプレイに映像を出力するための表示回路と、カメラから映像を取り込むためのキャプチャ回路を構築し、基礎を固めます。秋学期は「グラフィックスLSIとSoC設計」をテーマに、映像信号の加工やテクスチャの描画を行うグラフィックスLSIの設計を行い、最終的にはそれらを用いて各自がオリジナルの組み込みシステムを提案し、プレゼンテーションを行うことで、実社会で通用する応用力を身につけます。
 
 <p style="text-align:right">(<a href="http://www.cojt.or.jp/tkb/outline/index.html">COJTのホームページ</a>より引用)</p>

機械語より低レイヤ、自作CPUと同じレイヤのことをやる ハード なコースなのです。

### 表示回路

「FPGAボード上のDDR3メモリから画像を読み込み、その画像をHDMI信号としてディスプレイに出力する課題」

文章にすればこれだけの課題です。が、それが難しいのです。

まずはHDMI信号を自力で生成するところから始まります。

与えられた資料を読みながら、水平同期信号と垂直同期信号を決まった長さ、決まった数で生成・出力します。

同期信号がうまくディスプレイに認識してもらえたら、いよいよ映像信号の出力なのですが、これが難しい。

いつもならソフト側でVRAM(メモリ)に任意の画像データを書き込めば、それをハードウェア側が映像信号として出力してくれるものですが、今回はそのハードウェアそのものを作っているのです。

したがって、メモリに対するアクセスを自力で行う必要があり、それはつまり、メモリのアドレスバスとデータバスの信号線に対して自分で0,1を書き込んでタイミングよくメモリとの通信を行わなければならないということを意味します。

メモリバスはAXIバスというインターフェースによって定義されていて、バスに対する操作はすべてこのAXIバスプロトコルに従う必要があります。

COJTハードウェアコースの本質はAXIバスに対するコントローラを記述するというところにあるのです。

アドレスバスに送るアドレスの生成、VALID信号の生成、READY信号の確認はどうやって、いつ行うか、その条件は？

FIFOにデータを溜め込みすぎて溢れないようにするにはアドレスバスをどういうタイミングで、どういう条件で操作すれば良いのか。

垂直・水平同期信号のタイミングに合わせたFIFOからの読み出しを過不足ないように行うにはどのような条件を見れば良いのか。

どういう状態を定義してどういう条件で状態遷移するべきか。

考えることは山ほどあって、複雑に絡み合う条件を上手にまとめた論理回路を設計し、課題を達成します。これはやってみないと分からないのですが、なかなかうまくいきません。

画面が映らないとか、映像が乱れる、映像がずれるみたいなトラブルが起きます。

それから表示回路の動作を設定するためのインターフェースであるレジスタも設計します。

レジスタというのはあのレジスタのことで、CPUからレジスタに対して送られてくるアクセスをさばきます。

人間がレジスタに対する読み書きの命令を書くと、CPUはその命令を実行してレジスタバスに読み書きの信号を送るので、その読み書きの信号に対して適切に反応することが求められます。

### キャプチャ回路

表示回路が「メモリから読み込む」回路だったのに対して、キャプチャ回路は「Webカメラからのデータをメモリに書き込む」回路です。

ただ書き込むのではなく、Webカメラから得られるUYVYデータをRGBデータに変換しながらメモリに書き込みます。

表示回路が作れればそんなに難しいものではないです。

キャプチャ回路でメモリに書き込んだそばから、先の表示回路が映像を出力していくことになるので、メモリバスの帯域消費が増えます。

### 描画回路

VRAMやレジスタに対する読み書き演算モリモリの、総まとめみたいな複雑な課題です。

CPUによってレジスタに書き込まれる独自のグラフィックスコマンドをを解釈・実行する回路です。

命令に従って、指定された範囲の画像をメモリから読み込み、画素に対して透過や合成などの演算を行い、またメモリに書き戻すことが求められます。

定義する状態数とか状態遷移が多くなって考えるのに非常に苦労します。

命令に応じて処理すべき画素が何行何列かと範囲が変動するので、適切にメモリアドレスを生成しなければなりません。さらに、画素の演算は1クロックでは間に合わないので数クロック分パイプライン処理をしなければならないのですが、これがまた他の信号のタイミングに影響したりと一筋縄ではいかないのでした。

自作CPUがこれより複雑で大変だと考えると自作CPUしてみたいという気持ちが消え失せても仕方ないっすわ。

<small>ちなみに描画回路まで完成させたのは最終的に12人中4人だったので結構頑張ったのではないかと思います</small>
